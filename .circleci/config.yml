version: 2.1

orbs:
  node: circleci/node@5.1.0

jobs:
  test-server:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: server
      - run:
          name: Run Server Security Audit
          command: cd server && npm audit --audit-level=moderate || true
      - run:
          name: Run Server Tests
          command: cd server && npm test

  test-client:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - node/install-packages:
          pkg-manager: npm
          app-dir: client
      - run:
          name: Run Client Security Audit
          command: cd client && npm audit --audit-level=moderate || true
      - run:
          name: Build Client
          command: cd client && npm run build

  security-scan:
    docker:
      - image: cimg/node:18.0
    steps:
      - checkout
      - run:
          name: Install Dependencies
          command: |
            cd server && npm install
            cd ../client && npm install
      - run:
          name: Run Security Audit (Server)
          command: cd server && npm audit
      - run:
          name: Run Security Audit (Client)
          command: cd client && npm audit

workflows:
  test-and-deploy:
    jobs:
      - test-server
      - test-client
      - security-scan